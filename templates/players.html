{% extends "base.html" %}
{% block title %}Players Management{% endblock %}

{% block content %}
<div style="max-width:900px;margin:20px auto;padding:12px;">
  <h1>Players / Teams</h1>

  <div id="messages" style="margin-bottom:8px;color:#c00"></div>

  <label><strong>Game</strong></label>
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
    <select id="gamesSelect"></select>
    <button id="btnNewGame">New Game</button>
    <input id="newGameName" placeholder="New game name (if creating)" style="display:none;">
    <button id="btnLoad" style="margin-left:6px">Load Players</button>
  </div>

  <div id="playersArea">
    <div style="margin-bottom:8px;">
    {% if current_user.is_admin %}
      <button id="addPlayerBtn">Add Player</button>
      <button id="savePlayersBtn">Save All Changes</button>
    {% endif %}
    </div>

    <ol id="playersList" style="padding-left:20px;"></ol>
  </div>
</div>

<script>
(async function(){
  // --- INITIALIZATION ---
  const isAdmin = {{ 'true' if current_user.is_admin else 'false' }};
  const gamesSel = document.getElementById('gamesSelect');
  const btnNewGame = document.getElementById('btnNewGame');
  const newGameName = document.getElementById('newGameName');
  const btnLoad = document.getElementById('btnLoad');
  const playersList = document.getElementById('playersList');
  const msg = document.getElementById('messages');

  const btnAdd = document.getElementById('addPlayerBtn'); 
  const btnSave = document.getElementById('savePlayersBtn');

  function showMsg(s, color='#c00'){ msg.style.color=color; msg.textContent=s; }
  function clearMsg(){ msg.textContent=''; }

  // --- FETCH HELPERS ---
  async function fget(url){
    const res = await fetch(url, { credentials: 'same-origin' });
    if(!res.ok) { const t = await res.text(); throw new Error(t || res.statusText); }
    return res.json();
  }

  async function fpost(url, body){
    const res = await fetch(url, {
      method:'POST', credentials:'same-origin',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!res.ok){
      let j; try{ j = await res.json(); }catch(e){}
      throw new Error((j && (j.detail || j.error)) || (await res.text()) || res.statusText);
    }
    return res.json();
  }

  async function fdelete(url, body){
    const res = await fetch(url, {
      method:'DELETE', credentials:'same-origin',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!res.ok){
      let j; try{ j = await res.json(); }catch(e){}
      throw new Error((j && (j.detail || j.error)) || (await res.text()) || res.statusText);
    }
    return res.json();
  }

  // --- CORE LOGIC ---
  async function loadGames(){
    try{
      clearMsg();
      const games = await fget('/api/games');
      gamesSel.innerHTML = '';

      const empty = document.createElement('option');
      empty.value='';
      empty.text='-- choose game --';
      gamesSel.appendChild(empty);

      games.forEach((g, index) => {
        const o = document.createElement('option');
        o.value = String(g.id);
        o.textContent = g.name;
        gamesSel.appendChild(o);

        if (index === 0) {
          gamesSel.value = o.value;
        }
      });
    } catch(e){
      showMsg('Error loading games: ' + e.message);
    }
  }

  async function loadPlayersForGame(gameId){
    if (!gameId) {
      playersList.innerHTML = '';
      showMsg('No game selected.');
      return;
    }
    try{
      clearMsg();
      const players = await fget(`/api/players?game_id=${encodeURIComponent(gameId)}`);
      renderPlayersList(players);
    } catch(e){
      showMsg('Error loading players: ' + e.message);
    }
  }

  function renderPlayersList(items){
    playersList.innerHTML = '';
    const rows = Array.isArray(items) ? items : [];
    if (rows.length === 0) {
      const li = document.createElement('li');
      li.textContent = 'No players found for this game.';
      li.style.fontStyle = 'italic';
      li.style.color = '#555';
      playersList.appendChild(li);
      return;
    }

    rows.forEach(entry => {
      const name = entry?.name || '';
      const li = document.createElement('li');
      li.style.marginBottom='6px';

      const input = document.createElement('input');
      input.type='text';
      input.value = name;
      input.placeholder='player name';
      input.style.width='320px';
      if (!isAdmin) input.disabled = true;

      li.appendChild(input);
      playersList.appendChild(li);
    });
  }

  // --- EVENT LISTENERS ---
  btnLoad.onclick = async () => {
    const gid = gamesSel.value;
    if (!gid) { showMsg('Please select a game first.'); return; }
    await loadPlayersForGame(gid);
  };

  btnNewGame.onclick = () => {
    if(!isAdmin){ showMsg('Only admins can create games'); return; }
    newGameName.style.display =
      newGameName.style.display === 'none' ? 'inline-block' : 'none';
    if(newGameName.style.display !== 'none'){ newGameName.focus(); gamesSel.value=''; }
  };

  gamesSel.onchange = () => clearMsg();

  // --- INITIAL LOAD ---
  await loadGames();
})();
</script>
{% endblock %}
