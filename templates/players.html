{% extends "base.html" %}
{% block title %}Players Management{% endblock %}

{% block content %}
<div style="max-width:900px;margin:20px auto;padding:12px;">
  <h1>Players / Teams</h1>

  <div id="messages" style="margin-bottom:8px;color:#c00"></div>

  <label><strong>Game</strong></label>
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
    <select id="gamesSelect"></select>
    <button id="btnNewGame">New Game</button>
    <input id="newGameName" placeholder="New game name (if creating)" style="display:none;">
    <button id="btnLoad" style="margin-left:6px">Load Players</button>
  </div>

  <div id="playersArea">
    <div style="margin-bottom:8px;">
    {% if current_user.is_admin %}
      <button id="addPlayerBtn">Add Player</button>
      <button id="savePlayersBtn">Save All Changes</button>
    {% endif %}
    </div>

    <ol id="playersList" style="padding-left:20px;"></ol>
  </div>
</div>

<script>
(async function(){
  const gamesSel = document.getElementById('gamesSelect');
  const btnNewGame = document.getElementById('btnNewGame');
  const newGameName = document.getElementById('newGameName');
  const btnLoad = document.getElementById('btnLoad');
  const playersList = document.getElementById('playersList');
  const msg = document.getElementById('messages');

  // --- ADMIN ONLY BUTTONS ---
  const btnAdd = document.getElementById('addPlayerBtn'); 
  const btnSave = document.getElementById('savePlayersBtn');

  function showMsg(s,color='#c00'){ msg.style.color=color; msg.textContent=s; }
  function clearMsg(){ msg.textContent=''; }

  // fetch helpers
  async function fget(url){
    const res = await fetch(url, { credentials: 'same-origin' });
    if(!res.ok) { const t = await res.text(); throw new Error(t || res.statusText); }
    return res.json();
  }
  async function fpost(url, body){
    const res = await fetch(url, {
      method:'POST', credentials:'same-origin',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!res.ok){
      let j; try{ j = await res.json(); }catch(e){}
      throw new Error((j && (j.detail || j.error)) || (await res.text()) || res.statusText);
    }
    return res.json();
  }
  async function fdelete(url, body){
    const res = await fetch(url, {
      method:'DELETE', credentials:'same-origin',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!res.ok){
      let j; try{ j = await res.json(); }catch(e){}
      throw new Error((j && (j.detail || j.error)) || (await res.text()) || res.statusText);
    }
    return res.json();
  }

  async function loadGames(){
    try{
      clearMsg();
      const games = await fget('/api/games');
      gamesSel.innerHTML = '';
      const empty = document.createElement('option'); empty.value=''; empty.text='-- choose game --';
      gamesSel.appendChild(empty);
      games.forEach(g => {
        const o = document.createElement('option');
        o.value = g.id; o.text = g.name;
        gamesSel.appendChild(o);
      });
    }catch(e){ showMsg('Error loading games: '+e.message); }
  }

  async function loadPlayersForGame(gameId){
    try{
      clearMsg();
      const url = gameId ? `/api/players?game_id=${encodeURIComponent(gameId)}` : '/api/players';
      const players = await fget(url);
      renderPlayersList(players);
    }catch(e){ showMsg('Error loading players: '+e.message); }
  }

  function renderPlayersList(items){
    playersList.innerHTML = '';
    const rows = Array.isArray(items) ? items : [];
    if(rows.length === 0){
      renderPlayersList([{name:''}]);
      return;
    }
    rows.forEach((entry, idx) => {
      const name = (typeof entry === 'string') ? entry : (entry.name || '');
      const id = (typeof entry === 'object' && entry.id) ? entry.id : null;

      const li = document.createElement('li');
      li.style.marginBottom='6px';
      if(id) li.dataset.playerId = String(id);

      const input = document.createElement('input');
      input.type='text'; input.value = name || ''; input.placeholder = 'player name';
      input.style.width='320px';

      // Only show/enable inputs and remove buttons for Admins
      if (!btnAdd) input.disabled = true; 

      li.appendChild(input);

      if (btnAdd) { // If btnAdd exists, user is admin
          const btnRem = document.createElement('button');
          btnRem.textContent='Remove'; btnRem.style.marginLeft='8px';
          btnRem.onclick = async (ev) => {
            ev.preventDefault();
            clearMsg();
            const pid = li.dataset.playerId ? Number(li.dataset.playerId) : null;
            if(!pid){ li.remove(); return; }
            if(!confirm('Remove player from database?')) return;
            try{
              await fdelete('/api/players', { id: pid });
              li.remove();
              showMsg('Player removed', '#080');
            }catch(err){ showMsg('Remove failed: ' + err.message, '#c00'); }
          };
          li.appendChild(btnRem);
      }
      playersList.appendChild(li);
    });
  }

  // --- WRAP ADMIN ACTIONS IN IF BLOCKS ---
  if (btnAdd) {
      btnAdd.onclick = ()=> {
        const li = document.createElement('li');
        li.style.marginBottom='6px';
        const input = document.createElement('input');
        input.type='text'; input.placeholder='player name'; input.style.width='320px';
        const btnRem = document.createElement('button'); btnRem.textContent='Remove'; btnRem.style.marginLeft='8px';
        btnRem.onclick = ()=> li.remove();
        li.appendChild(input); li.appendChild(btnRem);
        playersList.appendChild(li);
        input.focus();
      };
  }

  if (btnSave) {
      btnSave.onclick = async ()=> {
        const inputs = Array.from(playersList.querySelectorAll('li input'));
        const players = inputs.map(i=>i.value.trim()).filter(Boolean);
        if(players.length === 0){ showMsg('Add at least one player'); return; }
        const payload = {};
        const gid = gamesSel.value;
        if(gid) payload.game_id = Number(gid);
        else {
          const nm = newGameName.value && newGameName.value.trim();
          if(!nm){ showMsg('Enter name for new game or select an existing game'); return; }
          payload.name = nm;
        }
        payload.players = players;
        try{
          clearMsg();
          const resp = await fpost('/players', payload);
          showMsg('Saved: '+resp.name, '#080');
          await loadGames();
          if(resp.id){ gamesSel.value = resp.id; }
          await loadPlayersForGame(resp.id || gid || null);
        }catch(e){ showMsg('Save failed: '+ e.message); }
      };
  }

  // --- ACCESSIBLE TO EVERYONE ---
  btnNewGame.onclick = ()=> {
    if(!btnAdd) { showMsg('Only admins can create games'); return; }
    newGameName.style.display = newGameName.style.display === 'none' ? 'inline-block' : 'none';
    if(newGameName.style.display !== 'none') { newGameName.focus(); gamesSel.value = ''; }
  };

  btnLoad.onclick = async ()=> {
    const gid = gamesSel.value;
    await loadPlayersForGame(gid || null);
  };

  await loadGames();
})();
</script>
{% endblock %}
