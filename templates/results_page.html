{% extends "base.html" %}
{% block title %}Match Day Dashboard{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    
    <div class="card input-card">
        <h2>Submit Match Results</h2>
        <div id="errorMsg" class="error-msg"></div>
        
        <div class="meta-row">
            <input id="gameDateInput" type="date">
            <button id="loadTeamsBtn" class="btn primary">Load Teams</button>
        </div>

        <div class="table-container">
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">#</th>
                        <th style="width: 80px;">Team</th>
                        <th style="width: 200px;">Player</th>
                        <th style="width: 80px;">Points</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    <tr><td colspan="4" class="placeholder">Select date and load teams...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="form-actions">
            <div id="pointsStatus" class="status-text">Ready</div>
            <button id="submitResultsBtn" class="btn success" disabled>Submit Results</button>
        </div>
    </div>

    <div class="card standings-card">
        <h2>Standings</h2>
        <div class="table-container">
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th style="width: 200px;">Player</th>
                        <th class="num">MP</th>
                        <th class="num">Pts</th>
                        <th class="num">Rank</th>
                    </tr>
                </thead>
                <tbody>
                    {% if rankview %}
                        {% for r in rankview %}
                        <tr>
                            <td class="player-name">
                                {{ r['Player'] or r['player'] or 'â€”' }}
                            </td>
                            <td class="num">
                                {# Check all possible MP keys #}
                                {{ r['MP'] or r['Played'] or r['mp'] or r['played'] or 0 }}
                            </td>
                            <td class="num">
                                {{ r['Points'] or r['points'] or 0 }}
                            </td>
                            <td class="num">
                                {{ r['Rank'] or r['rank'] or '-' }}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="4" class="placeholder">No standings found.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    /* 1. Remove base.html centering to pin to top-left */
    .container { 
        max-width: none !important; 
        margin: 0 !important; 
        padding: 0 !important;
        background: transparent !important;
        box-shadow: none !important;
    }

    .dashboard-wrapper {
        display: flex;
        gap: 30px; /* Increased gap between panels */
        padding: 25px;
        align-items: flex-start;
        justify-content: flex-start;
    }

    .card {
        background: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        width: fit-content;
        min-width: 450px; /* Prevents the tables from feeling "shrunk" */
    }

    h2 { font-size: 1.2rem; margin-top: 0; color: #333; border-bottom: 2px solid #f0f0f0; padding-bottom: 12px; }

    /* Tables */
    .dashboard-table { 
        border-collapse: collapse; 
        width: auto; 
        font-size: 0.95rem; 
        margin-top: 10px;
    }
    
    .dashboard-table th, .dashboard-table td { 
        padding: 12px 15px; 
        border-bottom: 1px solid #f0f0f0; 
        text-align: left; 
    }

    .dashboard-table th { 
        background: #fdfdfd; 
        color: #888; 
        font-size: 0.75rem; 
        text-transform: uppercase; 
        letter-spacing: 0.05em;
    }

    /* Column Specifics */
    .num { text-align: center !important; width: 70px; }
    .player-name { font-weight: 600; color: #111; }
    .points-select { 
        width: 100%; 
        padding: 6px; 
        border-radius: 4px; 
        border: 1px solid #ddd;
    }

    /* UI Elements */
    .meta-row { display: flex; gap: 12px; margin: 15px 0; }
    .meta-row input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    
    .form-actions { 
        margin-top: 20px; 
        padding-top: 15px;
        border-top: 1px solid #eee;
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }

    .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; transition: 0.2s; }
    .btn.primary { background: #2A6FDB; color: white; }
    .btn.success { background: #1B9E5A; color: white; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .status-text { font-size: 0.9rem; font-weight: 600; }
    .placeholder { color: #aaa; padding: 40px !important; text-align: center; font-style: italic; }
</style>

<script>
(function() {
    const dateInput = document.getElementById('gameDateInput');
    const loadBtn = document.getElementById('loadTeamsBtn');
    const resultsBody = document.getElementById('resultsBody');
    const submitBtn = document.getElementById('submitResultsBtn');
    const statusText = document.getElementById('pointsStatus');

    // Default to today
    dateInput.value = new Date().toISOString().split('T')[0];

    async function loadTeams() {
        const date = dateInput.value;
        statusText.textContent = "Loading teams...";
        
        try {
            const resp = await fetch(`/get_locked_teams?date=${date}`);
            const data = await resp.json();

            if (!resp.ok || !data.teams || Object.keys(data.teams).length === 0) {
                resultsBody.innerHTML = '<tr><td colspan="4" class="placeholder">No locked teams for this date.</td></tr>';
                submitBtn.disabled = true;
                return;
            }
            renderInputRows(data.teams);
        } catch (e) {
            resultsBody.innerHTML = '<tr><td colspan="4" style="color:red">Failed to load data.</td></tr>';
        }
    }

    function renderInputRows(teams) {
        resultsBody.innerHTML = "";
        let i = 1;
        ['Orange', 'Yellow'].forEach(teamName => {
            const players = teams[teamName] || [];
            players.forEach(p => {
                const tr = document.createElement('tr');
                tr.dataset.playerId = p.player_id || p.id;
                const name = p.name || p.Player || p.player || "Unknown";
                
                tr.innerHTML = `
                    <td>${i++}</td>
                    <td style="font-weight:bold; color: ${teamName === 'Orange' ? '#f57c00' : '#fbc02d'}">${teamName}</td>
                    <td class="player-name">${name}</td>
                    <td>
                        <select class="points-select">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="3">3</option>
                        </select>
                    </td>`;
                resultsBody.appendChild(tr);
            });
        });
        
        resultsBody.querySelectorAll('.points-select').forEach(s => s.onchange = validate);
        validate();
    }

    function validate() {
        const selects = Array.from(resultsBody.querySelectorAll('.points-select'));
        const total = selects.reduce((sum, s) => sum + parseInt(s.value), 0);
        const count = selects.length;
        
        let allowed = (count === 12) ? [12, 18] : (count === 10) ? [10, 15] : [count];
        const isOk = allowed.includes(total);
        
        statusText.textContent = `Total: ${total} / Players: ${count}`;
        statusText.style.color = isOk ? "#1B9E5A" : "#d32f2f";
        submitBtn.disabled = !isOk;
    }

    submitBtn.onclick = async () => {
        const payload = {
            Date: dateInput.value,
            results: Array.from(resultsBody.querySelectorAll('tr')).map(tr => ({
                player_id: parseInt(tr.dataset.playerId),
                points: parseInt(tr.querySelector('.points-select').value)
            }))
        };
        
        const resp = await fetch('/results', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (resp.ok) {
            window.location.reload(); 
        } else {
            alert("Submission failed.");
        }
    };

    loadBtn.onclick = loadTeams;
})();
</script>
{% endblock %}
